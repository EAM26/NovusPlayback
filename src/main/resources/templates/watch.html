<!doctype html>
<html lang="nl" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <title>Playback MVP</title>

    <style>
        .dots::after {
            content: "";
            display: inline-block;
            width: 1.2em;
            text-align: left;
            animation: dots 1s steps(4, end) infinite;
        }

        .dots.paused::after {
            animation: none;
            content: "";
        }

        @keyframes dots {
            0%   { content: ""; }
            17%  { content: "."; }
            34%  { content: ".."; }
            51%  { content: "..."; }
            68%  { content: "...."; }
            85%  { content: "....."; }
            100% { content: ""; }
        }
    </style>
</head>

<body style="font-family: sans-serif; padding: 16px;">
<h3>Playback MVP (browser)</h3>

<form id="f" style="display: grid; gap: 8px; max-width: 420px;">
    <label>
        Camera
        <input name="camera" type="number" required min="1" th:value="${form.camera}">
    </label>

    <label>
        Date
        <input name="date" type="date" required th:value="${form.date}">
    </label>

    <label>
        Time
        <input name="time" type="time" step="1" required th:value="${form.time}">
    </label>

    <label>
        Time Length (sec)
        <input name="timeLen" type="number" min="1" max="300" required th:value="${form.timeLen}">
    </label>

    <label>
        StreamType
        <input name="streamType" type="text" required th:value="${form.streamType}">
    </label>

    <div id="dlStatus" style="margin-top: 8px; display:none;">
        <span id="dlText">Downloading</span><span class="dots paused"></span>
    </div>

    <button type="submit">Preview</button>
    <button type="button" id="downloadBtn">Download</button>
</form>

<div style="margin-top: 16px;">
    <video id="v" controls style="width: 100%; max-width: 900px;"></video>
</div>

<script>
    const form = document.getElementById("f");
    const video = document.getElementById("v");
    const downloadBtn = document.getElementById("downloadBtn");

    const dlStatus = document.getElementById("dlStatus");
    const dlText = document.getElementById("dlText");
    const dlDots = document.querySelector(".dots");

    // PREVIEW (ongewijzigd)
    form.addEventListener("submit", (e) => {
        e.preventDefault();
        const params = new URLSearchParams(new FormData(form));
        video.src = "/api/clip.mp4?" + params.toString();
        video.load();
        video.play().catch(() => {});
    });

    // DOWNLOAD
    downloadBtn.addEventListener("click", async () => {
        const params = new URLSearchParams(new FormData(form));
        params.set("download", "true");

        const url = "/api/clip.mp4?" + params.toString();

        // UI: start
        dlText.textContent = "Downloading";
        dlDots.classList.remove("paused");
        dlStatus.style.display = "block";
        downloadBtn.disabled = true;

        try {
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error("HTTP " + response.status);
            }

            // hier weten we zeker: download-data is volledig binnen
            const blob = await response.blob();

            const disposition = response.headers.get("Content-Disposition") || "";
            const match = disposition.match(/filename="([^"]+)"/i);
            const filename = match ? match[1] : "clip.mp4";

            const objectUrl = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = objectUrl;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(objectUrl);

            dlText.textContent = "Download finished";
            dlDots.classList.add("paused");
            setTimeout(() => dlStatus.style.display = "none", 1500);

        } catch (err) {
            console.error(err);
            dlText.textContent = "Download failed";
            dlDots.classList.add("paused");
            setTimeout(() => dlStatus.style.display = "none", 2500);
        } finally {
            downloadBtn.disabled = false;
        }
    });
</script>

</body>
</html>
