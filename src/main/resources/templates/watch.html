<!doctype html>
<html lang="nl" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <title>Playback MVP</title>
</head>
<body style="font-family: sans-serif; padding: 16px;">
<h3>Playback MVP (browser)</h3>

<form id="f" style="display: grid; gap: 8px; max-width: 420px;">
    <label>
        Camera
        <input name="camera" type="number" required min="1" th:value="${form.camera}">
    </label>

    <label>
        Date
        <input name="date" type="date" required th:value="${form.date}">
    </label>

    <label>
        Time
        <input name="time" type="time" step="1" required th:value="${form.time}">
    </label>

    <label>
        TimeLen (sec)
        <input name="timeLen" type="number" min="1" max="300" required th:value="${form.timeLen}">
    </label>

    <label>
        StreamType
        <input name="streamType" type="text" required th:value="${form.streamType}">
    </label>
    <div id="dlStatus" style="margin-top: 8px; display:none;">
        Downloading...
    </div>

    <button type="submit">Preview</button>

    <button type="button" id="downloadBtn">Download</button>
</form>

<div style="margin-top: 16px;">
    <video id="v" controls style="width: 100%; max-width: 900px;"></video>
</div>

<script>
    const form = document.getElementById("f");
    const video = document.getElementById("v");
    const downloadBtn = document.getElementById("downloadBtn");

    form.addEventListener("submit", (e) => {
        e.preventDefault();

        const params = new URLSearchParams(new FormData(form));
        video.src = "/api/clip.mp4?" + params.toString();
        video.load();
        video.play().catch(() => {});
    });

    downloadBtn.addEventListener("click", () => {
        const params = new URLSearchParams(new FormData(form));
        params.set("download", "true"); // Nederlands: alleen de knop zet dit

        const url = "/api/clip.mp4?" + params.toString();

        // Nederlands: toon eenvoudige feedback (geen echte progress)
        dlStatus.style.display = "block";
        dlStatus.textContent = "Downloading...";

        // Nederlands: start download via hidden iframe zodat je op dezelfde pagina blijft
        const iframe = document.createElement("iframe");
        iframe.style.display = "none";
        iframe.src = url;

        iframe.onload = () => {
            // Nederlands: dit is niet perfect betrouwbaar, maar geeft iig “klaar/gestart” gevoel
            dlStatus.textContent = "Download started.";
            setTimeout(() => {
                dlStatus.style.display = "none";
                iframe.remove();
            }, 1500);
        };

        iframe.onerror = () => {
            dlStatus.textContent = "Download failed.";
            setTimeout(() => {
                dlStatus.style.display = "none";
                iframe.remove();
            }, 2500);
        };

        document.body.appendChild(iframe);
    });
</script>

</body>
</html>
