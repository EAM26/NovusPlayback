<!doctype html>
<html lang="nl" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <title>Playback MVP</title>

    <style>
        .banner {
            margin-top: 12px;
            padding: 10px 14px;
            border-radius: 6px;

            background-color: #e7f1ff;
            color: #0b3d91;

            font-weight: 600;
            font-size: 1.05rem;

            display: flex;
            align-items: center;
            gap: 6px;

            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .banner .icon {
            font-size: 1.2rem;
        }

        .dots {
            display: inline-flex;
            gap: 2px;
            margin-left: 2px;
        }

        .dots span {
            opacity: 0.2;
            animation: blink 1s infinite;
        }

        .dots span:nth-child(2) { animation-delay: 0.2s; }
        .dots span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes blink {
            0%, 20% { opacity: 0.2; }
            50% { opacity: 1; }
            100% { opacity: 0.2; }
        }

        .dots.paused span {
            animation: none;
            opacity: 0.2;
        }
    </style>

</head>

<body style="font-family: sans-serif; padding: 16px;">
<h3>Playback MVP (browser)</h3>

<form id="f" style="display: grid; gap: 8px; max-width: 420px;">
    <label>
        Camera
        <input name="camera" type="number" required min="1" th:value="${form.camera}">
    </label>

    <label>
        Date
        <input name="date" type="date" required th:value="${form.date}">
    </label>

    <label>
        Time
        <input name="time" type="time" step="1" required th:value="${form.time}">
    </label>

    <label>
        Time Length (sec)
        <input name="timeLen" type="number" min="1" max="300" required th:value="${form.timeLen}">
    </label>

    <label>
        StreamType
        <input name="streamType" type="text" required th:value="${form.streamType}">
    </label>

    <!-- DOWNLOAD STATUS -->
    <div id="dlStatus" class="banner" style="display:none;">
        <span class="icon">â¬‡</span>
        <span id="dlText">Downloading</span>

        <span id="dlDots" class="dots" aria-hidden="true">
      <span>.</span><span>.</span><span>.</span>
    </span>
    </div>

    <button type="submit">Preview</button>
    <button type="button" id="downloadBtn">Download</button>
    <button type="button" id="snapshotBtn">Take snapshot</button>

    <!-- SNAPSHOT STATUS -->
    <div id="snapStatus" class="banner" style="display:none;">
        <span class="icon">ðŸ“¸</span>
        <span id="snapText">Snapshot available</span>
    </div>

    <canvas id="snapCanvas" style="display:none;"></canvas>
</form>

<div style="margin-top: 16px;">
    <video id="v" controls style="width: 100%; max-width: 900px;"></video>
</div>

<script>
    const form = document.getElementById("f");
    const video = document.getElementById("v");

    const downloadBtn = document.getElementById("downloadBtn");
    const snapshotBtn = document.getElementById("snapshotBtn");

    const dlStatus = document.getElementById("dlStatus");
    const dlText = document.getElementById("dlText");
    const dlDots = document.getElementById("dlDots");

    const snapStatus = document.getElementById("snapStatus");
    const snapText = document.getElementById("snapText");

    const canvas = document.getElementById("snapCanvas");
    const ctx = canvas.getContext("2d");

    function showBanner(bannerEl, textEl, text, dotsEl, dotsRunning, autoHideMs) {
        textEl.textContent = text;

        bannerEl.style.display = "flex";

        if (dotsEl) {
            if (dotsRunning) {
                dotsEl.classList.remove("paused");
            } else {
                dotsEl.classList.add("paused");
            }
        }

        if (autoHideMs && autoHideMs > 0) {
            setTimeout(() => { bannerEl.style.display = "none"; }, autoHideMs);
        }
    }

    // PREVIEW
    form.addEventListener("submit", (e) => {
        e.preventDefault();
        const params = new URLSearchParams(new FormData(form));
        video.src = "/api/clip.mp4?" + params.toString();
        video.load();
        video.play().catch(() => {});
    });

    // DOWNLOAD
    downloadBtn.addEventListener("click", async () => {
        const params = new URLSearchParams(new FormData(form));
        params.set("download", "true");

        const url = "/api/clip.mp4?" + params.toString();

        showBanner(dlStatus, dlText, "Downloading", dlDots, true, 0);
        downloadBtn.disabled = true;

        try {
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error("HTTP " + response.status);
            }

            const blob = await response.blob();

            const disposition = response.headers.get("Content-Disposition") || "";
            const match = disposition.match(/filename="([^"]+)"/i);
            const filename = match ? match[1] : "clip.mp4";

            const objectUrl = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = objectUrl;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(objectUrl);

            showBanner(dlStatus, dlText, "Download started", dlDots, false, 1500);

        } catch (err) {
            console.error(err);

            showBanner(dlStatus, dlText, "Download failed", dlDots, false, 2500);

        } finally {
            downloadBtn.disabled = false;
        }
    });

    // SNAPSHOT
    snapshotBtn.addEventListener("click", () => {
        if (!video.src) {
            showBanner(snapStatus, snapText, "No preview loaded", null, false, 1500);
            return;
        }

        if (video.readyState < 2) {
            showBanner(snapStatus, snapText, "Preview not ready yet", null, false, 1500);
            return;
        }

        const width = video.videoWidth;
        const height = video.videoHeight;

        if (!width || !height) {
            showBanner(snapStatus, snapText, "No video frame available", null, false, 1500);
            return;
        }

        canvas.width = width;
        canvas.height = height;
        ctx.drawImage(video, 0, 0, width, height);

        canvas.toBlob((blob) => {
            if (!blob) {
                showBanner(snapStatus, snapText, "Snapshot failed", null, false, 1500);
                return;
            }

            const now = new Date();
            const fileName = `snapshot-${now.toISOString().replaceAll(":", "-")}.png`;

            const objectUrl = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = objectUrl;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(objectUrl);

            showBanner(snapStatus, snapText, "Snapshot available", null, false, 1500);

        }, "image/png");
    });
</script>

</body>
</html>
